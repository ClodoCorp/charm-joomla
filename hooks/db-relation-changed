#!/bin/bash
# This must be renamed to the name of the relation. The goal here is to
# affect any change needed by relationships being formed, modified, or broken
# This script should be idempotent.
set -eux

juju-log $JUJU_REMOTE_UNIT modified its settings
juju-log Relation settings:
relation-get
juju-log Relation members:
relation-list

source inc/common

if [ -f "$config_file_path" ]; then
	# No longer to quietly in to that good night. Update the config file with new DB values
	juju-log "Joomla is already setup, just silently going away"
	exit 0
fi


database=`relation-get database`
user=`relation-get user`
password=`relation-get password`
host=`relation-get private-address`

if [ -z "$database" ] ; then
    exit 0
fi

secret_key=`pwgen 32 1`
#echo $secret_key > secret_key

juju-log Configuring Joomla
cat > $config_file_path << EOF
<?php
class JConfig {
   /* Site Settings generated by ensemble forumla */
   public \$offline = '0';
   public \$offline_message = 'This site is down for maintenance.<br /> Please check back again soon.';
   public \$sitename = 'Joomla!';
   public \$editor = 'tinymce';
   public \$list_limit = '20';
   public \$access = '1';
   public \$dbtype = 'mysql';
   public \$host = '$host';
   public \$user = '$user';
   public \$password = '$password';
   public \$db = '$database';
   public \$dbprefix = 'jos_';
   public \$secret = '$secret_key';
   public \$gzip = '0';
   public \$error_reporting = '-1';
   public \$helpurl = 'http://help.joomla.org/proxy/index.php?option=com_help&amp;keyref=Help{major}{minor}:{keyref}';
   public \$ftp_host = '';
   public \$ftp_port = '';
   public \$ftp_user = '';
   public \$ftp_pass = '';
   public \$ftp_root = '';
   public \$ftp_enable = '';
   public \$tmp_path = '/tmp';
   public \$log_path = '/var/logs';
   public \$live_site = '';
   public \$force_ssl = 0;
   public \$offset = 'UTC';
   public \$offset_user = 'UTC';
   public \$lifetime = '15';
   public \$session_handler = 'database';
   public \$mailer = 'mail';
   public \$mailfrom = '';
   public \$fromname = '';
   public \$sendmail = '/usr/sbin/sendmail';
   public \$smtpauth = '0';
   public \$smtpuser = '';
   public \$smtppass = '';
   public \$smtphost = 'localhost';
   public \$caching = '0';
   public \$cachetime = '15';
   public \$cache_handler = 'file';
   public \$debug = '0';
   public \$debug_lang = '0';
   public \$MetaDesc = 'Joomla! - the dynamic portal engine and content management system';
   public \$MetaKeys = 'joomla, Joomla';
   public \$MetaTitle = '1';
   public \$MetaAuthor = '1';
   public \$sef = '1';
   public \$sef_rewrite = '0';
   public \$sef_suffix = '0';
   public \$unicodeslugs = '0';
   public \$feed_limit = 10;
   public \$feed_email = 'author';
}
?>
EOF
chmod 0777 $config_file_path

juju-log Creating initial database
sed -e 's/#__/jos_/g' < $initdb_sql > /tmp/`basename $initdb_sql`
mysql -h $host -u $user --password=$password $database < /tmp/`basename $initdb_sql`
rm -f /tmp/`basename $initdb_sql`
mv /var/www/installation /var/www/installation_backup
chmod 000 /var/www/installation_backup

# create admin user (default pass is 123, change it imediately after install)
juju-log "Creating admin user"
cat > /tmp/joomla-admin.sql << EOF
INSERT INTO \`jos_users\` VALUES (42, 'Administrator', 'admin', 'your-email@email.com', '531b5f50f082c59730b3bf7f9c457129:GA8lZqlJVZQbD8GYFGltJGNNIvjmcRcT', 'Super Administrator', 0, 1, '2005-09-28 00:00:00', '2005-09-28 00:00:00', '', '', '2005-09-28 00:00:00', 0);
INSERT INTO \`jos_user_usergroup_map\` VALUES (42, 8);
EOF
mysql -h $host -u $user --password=$password $database < /tmp/joomla-admin.sql
rm -f /tmp/joomla-admin.sql

juju-log "Opening port 80"
open-port 80/tcp
